# File generated by gflows, do not modify
# Source: .gflows/workflows/integration-tests-legacy
name: Run integration tests
"on":
  push:
    branches:
    - master
    - f/*
    - r/*
    - b/*
jobs:
  integration-tests-legacy-small:
    name: Run legacy integration small tenants tests
    runs-on: self-hosted
    steps:
    - name: Checkout tests repository
      uses: actions/checkout@v2
      with:
        repository: covergo/integration-testing
        ref: ${{ github.ref }}
        token: ${{ secrets.CR_PAT_FULL }}
    - name: Checkout GitHub Action Repos
      uses: daspn/private-actions-checkout@v2
      with:
        actions_list: '[ "covergo/get-version@v1.4", "covergo/get-issue-key@v1.2",
          "covergo/docker-extract@v1", "covergo/docker-diagnose@v1.3", "covergo/set-compose-tags@v1",
          "covergo/run-in-compose@v1" ]'
        checkout_base_path: ./.github/actions
        app_id: ${{ secrets.PRIVATE_ACTION_APP_ID }}
        app_private_key: ${{ secrets.PRIVATE_ACTION_APP_PRIVATE_KEY }}
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v1
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.CR_PAT_FULL }}
    - name: Login to AliCloud Container Registry
      uses: docker/login-action@v1
      with:
        registry: registry-intl.cn-hongkong.aliyuncs.com
        username: ${{ secrets.ALI_CONTAINER_REGISTRY_USER }}
        password: ${{ secrets.ALI_CONTAINER_REGISTRY_PASSWORD }}
    - name: Prepare environment for integration tests
      uses: ./launch_environment
      with:
        mongo-user: ${{ secrets.MONGO_USER }}
        mongo-password: ${{ secrets.MONGO_PASSWORD }}
        mongo-url: dds-3ns0c4f035f4d3141258-pub.mongodb.rds.aliyuncs.com:3717,dds-3ns0c4f035f4d3142331-pub.mongodb.rds.aliyuncs.com:3717/admin?replicaSet=mgset-5830817&maxPoolSize=500&waitQueueMultiple=5
        service-under-test: none
        image-under-test: none
    - name: Install yarn
      run: yarn install
    - name: Run 123 tests
      run: yarn 123
    - name: Run 234 tests
      run: yarn 234
    - name: Run 234e_uat tests
      run: yarn 234e_uat
    - name: Run 45_uat tests
      run: yarn 45_uat
    - name: Run 56_uat tests
      run: yarn 56_uat
    - name: Gather test environment logs
      if: ${{ always() }}
      uses: ./.github/actions/docker-diagnose
      with:
        filter: name=covergo*
        diagnostic-result-path: diagnostics
        include-compose: true
    - name: Stop compose
      if: ${{ always() }}
      run: docker compose down --remove-orphans
    - name: Upload test environment logs
      if: ${{ always() }}
      uses: actions/upload-artifact@v2
      with:
        name: Small tenants legacy integration tests diagnostics
        path: diagnostics/*
  integration-tests-legacy-big:
    name: Run legacy integration big tenants tests
    runs-on: self-hosted
    steps:
    - name: Checkout tests repository
      uses: actions/checkout@v2
      with:
        repository: covergo/integration-testing
        ref: ${{ github.ref }}
        token: ${{ secrets.CR_PAT_FULL }}
    - name: Checkout GitHub Action Repos
      uses: daspn/private-actions-checkout@v2
      with:
        actions_list: '[ "covergo/get-version@v1.4", "covergo/get-issue-key@v1.2",
          "covergo/docker-extract@v1", "covergo/docker-diagnose@v1.3", "covergo/set-compose-tags@v1",
          "covergo/run-in-compose@v1" ]'
        checkout_base_path: ./.github/actions
        app_id: ${{ secrets.PRIVATE_ACTION_APP_ID }}
        app_private_key: ${{ secrets.PRIVATE_ACTION_APP_PRIVATE_KEY }}
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v1
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.CR_PAT_FULL }}
    - name: Login to AliCloud Container Registry
      uses: docker/login-action@v1
      with:
        registry: registry-intl.cn-hongkong.aliyuncs.com
        username: ${{ secrets.ALI_CONTAINER_REGISTRY_USER }}
        password: ${{ secrets.ALI_CONTAINER_REGISTRY_PASSWORD }}
    - name: Prepare environment for integration tests
      uses: ./launch_environment
      with:
        mongo-user: ${{ secrets.MONGO_USER }}
        mongo-password: ${{ secrets.MONGO_PASSWORD }}
        mongo-url: dds-3ns0c4f035f4d3141258-pub.mongodb.rds.aliyuncs.com:3717,dds-3ns0c4f035f4d3142331-pub.mongodb.rds.aliyuncs.com:3717/admin?replicaSet=mgset-5830817&maxPoolSize=500&waitQueueMultiple=5
        service-under-test: none
        image-under-test: none
    - name: Install yarn
      run: yarn install
    - name: Run test_uat tests
      run: yarn test_uat
    - name: Run test_uat1 tests
      run: yarn test_uat1
    - name: Run test_uat2 tests
      run: yarn test_uat2
    - name: Run test_uat3 tests
      run: yarn test_uat3
    - name: Run test_uat4 tests
      run: yarn test_uat4
    - name: Gather test environment logs
      if: ${{ always() }}
      uses: ./.github/actions/docker-diagnose
      with:
        filter: name=covergo*
        diagnostic-result-path: diagnostics
        include-compose: true
    - name: Stop compose
      if: ${{ always() }}
      run: docker compose down --remove-orphans
    - name: Upload test environment logs
      if: ${{ always() }}
      uses: actions/upload-artifact@v2
      with:
        name: Big tenants legacy integration tests diagnostics
        path: diagnostics/*
